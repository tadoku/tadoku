oathkeeper:
  config:
    log:
      level: debug
      format: json
      leak_sensitive_values: true

    serve:
      proxy:
        cors:
          enabled: true
          allowed_origins:
            - http://langlog.be
            - http://account.langlog.be
            - http://admin.langlog.be
          allowed_methods:
            - POST
            - GET
            - PUT
            - PATCH
            - DELETE
          allowed_headers:
            - Authorization
            - Content-Type
          exposed_headers:
            - Content-Type
          allow_credentials: true
          debug: true

    errors:
      fallback:
        - json

      handlers:
        redirect:
          enabled: true
          config:
            to: http://account.langlog.be/
            when:
              -
                error:
                  - unauthorized
                  - forbidden
                request:
                  header:
                    accept:
                      - text/html
        json:
          enabled: true
          config:
            verbose: true

    access_rules:
      matching_strategy: glob

    authenticators:
      anonymous:
        enabled: true
        config:
          subject: guest

      cookie_session:
        enabled: true
        config:
          check_session_url: http://kratos-public/sessions/whoami
          preserve_path: true
          extra_from: "@this"
          subject_from: "identity.id"
          only:
            - ory_kratos_session

      jwt:
        enabled: true
        config:
          jwks_urls:
            - file:///etc/secrets/kubernetes/jwks.json

      noop:
        enabled: true

    authorizers:
      allow:
        enabled: true

    mutators:
      noop:
        enabled: true

      id_token:
        enabled: true
        config:
          issuer_url: http://oathkeeper-api/
          jwks_url: file:///etc/secrets/oathkeeper/jwks.json
          claims: |
            {
              "type": "user",
              "session": {{ .Extra | toJson }}
            }

deployment:
  extraVolumes:
    - name: jwks
      secret:
        secretName: oathkeeper-jwks
    - name: kubernetes-jwks
      secret:
        secretName: kubernetes-jwks
  extraVolumeMounts:
    - name: jwks
      mountPath: /etc/secrets/oathkeeper
      readOnly: true
    - name: kubernetes-jwks
      mountPath: /etc/secrets/kubernetes
      readOnly: true
  extraEnv:
    - name: SSL_CERT_FILE
      value: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
